<!--
This build file contains a target for building a deployable webapp warfile containing
wayback with the netarchivesuite plugin
-->
<project>
    <import file="build.xml" />

    <property name="wayback.conf.root" value="wayback/prod"/>
    <!--
    Path to the wayback webapp as downloaded from  http://sourceforge.net/project/showfiles.php?group_id=118427
    -->
    <property name="wayback.dist.war" value="wayback/wayback-webapp-1.4.1.war" />

    <!--
    Path to a directory containing spring-framework config files to override the defaults supplied with wayback.
    The directory may also include a custom web.xml file.
    -->
    <property name="wayback.conf.dir" value="${wayback.conf.root}" />

    <!--
    A netarchivesuite settings file to be used by the netarchivesuite-wayback plugin. This file should
    contain any custom settings for the common and archive modules, specifically the connection information
    for the ArcRepository client to be used
    -->
    <property name="wayback.settings.file" value="${wayback.conf.root}/conf/settings_3.8.xml"/>

    <!--
    The name of the war-file to be generated. Note that for proxy-mode access to wayback it must be deployed in the ROOT
    context. One way of doing this it to name the warfile ROOT.war.
    -->
    <property name="wayback.war.name" value="ROOT.war"/>

    <property name="wayback.tempdir" value="wayback_tmp"/>

     <target name="show_properties">
           <echoproperties/>
     </target>

    <!--
    Generate the fully functional warfile ready for deployment.
    -->
    <target name="warfile" depends="jarfiles, unpack_warfile, copy_files, repack_warfile">
    </target>

    <target name="warfile.nocompile" depends="unpack_warfile, copy_files, repack_warfile" />

    <target name="unpack_warfile">
        <delete dir="${wayback.tempdir}"/>
        <unzip src="${wayback.dist.war}" dest="${wayback.tempdir}"/>
    </target>

    <target name="copy_files">
        <copy todir="${wayback.tempdir}/WEB-INF">
            <fileset dir="${wayback.conf.dir}">
                <include name="*.xml"/>
            </fileset>
        </copy>
        <copy todir="${wayback.tempdir}/WEB-INF/lib" flatten="yes">
            <fileset dir="lib">
                <include name="**/*.jar"/>
                <!--This next line ensures that we use the appropriate wayback core for the webapp, and not
                 the one we compiled our module against -->
                <exclude name="wayback-core*.jar"/>
                <exclude name="dk.netarkivet.deploy.jar"/>
                <exclude name="dk.netarkivet.harvester.jar"/>
                <exclude name="dk.netarkivet.viewerproxy.jar"/>
                <exclude name="dk.netarkivet.monitor.jar"/>
                <exclude name="heritrix*/**.jar"/>
                <exclude name="**/je-*.jar"/>
                <exclude name="**/jericho*.jar"/>
                <exclude name="**/jetty-*.jar"/>
                <exclude name="**/itext-*.jar"/>
                <exclude name="**/junit-*.jar"/>
                <exclude name="**/libidn-*.jar"/>
                <exclude name="**/poi-*.jar"/>
            </fileset>
        </copy>
        <copy file="${wayback.settings.file}" tofile="${wayback.tempdir}/WEB-INF/conf/settings.xml"/>
    </target>

    <target name="repack_warfile">
        <war basedir="${wayback.tempdir}" destfile="${wayback.war.name}"/>
    </target>

</project>

