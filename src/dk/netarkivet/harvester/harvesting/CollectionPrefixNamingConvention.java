/* File:       $Id: LegacyNamingConvention.java 2657 2013-04-15 15:56:33Z svc $
 * Revision:   $Revision: 2657 $
 * Author:     $Author: svc $
 * Date:       $Date: 2013-04-15 17:56:33 +0200 (Mon, 15 Apr 2013) $
 *
 * The Netarchive Suite - Software to harvest and preserve websites
 * Copyright 2004-2012 The Royal Danish Library, the Danish State and
 * University Library, the National Library of France and the Austrian
 * National Library.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */
package dk.netarkivet.harvester.harvesting;

import java.io.File;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import dk.netarkivet.common.exceptions.ArgumentNotValid;
import dk.netarkivet.common.exceptions.UnknownID;
import dk.netarkivet.common.utils.Settings;
import dk.netarkivet.harvester.datamodel.Job;

/** 
 * Implements another way of prefixing archive files in Netarchivesuite. 
 * I.e. collectionName-jobid-harvestid
 */
public class CollectionPrefixNamingConvention implements ArchiveFileNaming {
    
    /** The default place in classpath where the settings file can be found. */
    private static String defaultSettingsClasspath
            = "dk/netarkivet/harvester/harvesting/"
                +"CollectionPrefixNamingConventionSettings.xml";

    /*
     * The static initialiser is called when the class is loaded.
     * It will add default values for all settings defined in this class, by
     * loading them from a settings.xml file in classpath.
     */
    static {
        Settings.addDefaultClasspathSettings(defaultSettingsClasspath);
    }
    
    private static String COLLECTION_SETTING = "settings.harvester.harvesting.heritrix"
            + ".archiveNaming.collectionName";
    
    private static String CollectionName = Settings.get(COLLECTION_SETTING);
    
    
    public CollectionPrefixNamingConvention() {
    }

    @Override
    public String getPrefix(Job theJob) {
        return CollectionName + "-" 
                + theJob.getJobID() + "-" + theJob.getOrigHarvestDefinitionID();
    }
      
    /**
     * A class for parsing an filename as generated by our runs of Heritrix
     * and retrieving components like harvestID and jobID.
     */
    public static class LegacyFilenameParser extends ArchiveFilenameParser{
        
        private Log log = LogFactory.getLog(LegacyFilenameParser.class);

        /**
         * Our file names contain jobID, harvestID, timestamp and serial no.
         * as well as a collectionName before that.
         */
        private static final Pattern FILE_NAME_PATTERN =
            Pattern.compile(Pattern.quote(CollectionName) +
                    "\\-(\\d+)\\-(\\d+)\\-(\\d+)\\-(\\d+)\\-.*");

        /** pattern group containing the Job ID. */
        private static final int JOB_ID = 1;
        /** pattern group containing the harvest ID. */
        private static final int HARVEST_ID = 2;
        /** pattern group containing the timestamp. */
        private static final int TIME_STAMP = 3;
        /** pattern group containing the serial number. */
        private static final int SERIAL_NO = 4;

        /** Field containing the parsed harvest ID. */
        private final String harvestID;
        /** Field containing the parsed job Id. */
        private final String jobID;
        /** Field containing the timestamp. */
        private final String timeStamp;
        /** Field containing the serial number. */
        private final String serialNo;

        /** Field containing the original filename. */
        private final String filename;
        /**
         * Parses the name of the given file.
         * @param file An ARC/CDX file named following the NetarchiveSuite
         * convention.
         * @throws UnknownID if the file was NOT named following
         * NetarchiveSuite convention; or any other exception occurred
         */
        public LegacyFilenameParser(File file) throws UnknownID {
            ArgumentNotValid.checkNotNull(file, "File file");
            try {
                filename = file.getName();
                Matcher m = FILE_NAME_PATTERN.matcher(file.getName());
                if (m.matches()){
                    harvestID = m.group(HARVEST_ID);
                    jobID = m.group(JOB_ID);
                    timeStamp = m.group(TIME_STAMP);
                    serialNo = m.group(SERIAL_NO);
                } else {
                    String errMsg = "The name: '"
                        + filename
                        + "' did not match the NetarchiveSuite convention";
                    log.warn(errMsg);
                    throw new UnknownID(errMsg);
                }
            } catch (RuntimeException e) {
                String errMsg = "Could not parse the name '"
                    + file.getName() + "'.";
                log.warn(errMsg);
                throw new UnknownID(errMsg, e);
            }
        }
        
        /** 
         * Get the harvestID.
         * @return the harvestID.
         */
        public String getHarvestID() {
            return harvestID;
        }
        
        /** 
         * Get the job ID.
         * @return the Job ID.
         */
        public String getJobID() {
            return jobID;
        }
        
        /** 
         * Get the timestamp.
         * @return the timestamp.
         */
        public String getTimeStamp() {
            return timeStamp;
        }
        
        /** 
         * Get the serial number.
         * @return the serial number.
         */
        public String getSerialNo() {
            return serialNo;
        }
        
        /** 
         * Get the filename.
         * @return the filename.
         */
        public String getFilename() {
            return filename;
        }
    }


    @Override
    public ArchiveFilenameParser getArchiveFilenameParser(File f) {
        return new LegacyFilenameParser(f);
    }
}
